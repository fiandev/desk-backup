#!/bin/sh

# ==============================================================================
# DESK-BACKUP INSTALL SCRIPT
# ==============================================================================
# This script installs the desk-backup tool and sets up the necessary aliases
# for your shell (Bash, Zsh, or Fish).

# --- Configuration ---
# Destination for the main script
INSTALL_DIR="$HOME/.local/bin"

# --- Shell Detection ---
# A more reliable way to detect the current shell by checking the parent process.
PARENT_PROCESS_NAME=$(ps -o comm= -p $(ps -o ppid= -p $$))
CURRENT_SHELL=""

case "$PARENT_PROCESS_NAME" in
    *fish*) 
        CURRENT_SHELL="fish"
        ;;
    *bash*) 
        CURRENT_SHELL="bash"
        ;;
    *zsh*) 
        CURRENT_SHELL="zsh"
        ;;
    *)
        # Fallback to the less reliable $SHELL if ps fails
        CURRENT_SHELL=$(basename "$SHELL")
        ;;
esac

# --- Main Installation Function ---
main() {
    echo "--- Starting Desk-Backup Setup ---"

    # --- Step 1: Create installation directory ---
    echo "-> Ensuring installation directory exists at $INSTALL_DIR..."
    mkdir -p "$INSTALL_DIR"
    echo "   ...Done."

    # --- Step 2: Copy the main script ---
    echo "-> Copying the 'deskbackup' script to $INSTALL_DIR..."
    cp ./deskbackup "$INSTALL_DIR/"
    chmod +x "$INSTALL_DIR/deskbackup"
    echo "   ...Done."

    # --- Step 3: Install shell-specific aliases ---
    echo "-> Detected shell: $CURRENT_SHELL. Installing aliases..."

    case "$CURRENT_SHELL" in
        bash|zsh)
            # For Bash and Zsh, we source the aliases.sh file.
            ALIAS_FILE_PATH="$(pwd)/aliases.sh"
            CONFIG_FILE="$HOME/.bashrc"
            if [ "$CURRENT_SHELL" = "zsh" ]; then
                CONFIG_FILE="$HOME/.zshrc"
            fi

            echo "   -> Adding source line to $CONFIG_FILE..."
            if ! grep -q "source $ALIAS_FILE_PATH" "$CONFIG_FILE"; then
                printf "\n# Load Desk-Backup aliases\n" >> "$CONFIG_FILE"
                printf "source %s\n" "$ALIAS_FILE_PATH" >> "$CONFIG_FILE"
                echo "   ...Successfully added source line."
            else
                echo "   ...Source line already exists. Skipping."
            fi
            INSTRUCTION="source $CONFIG_FILE"
            ;;
        fish)
            # For Fish, we copy the function files to its functions directory.
            FISH_FUNC_DIR="$HOME/.config/fish/functions"
            mkdir -p "$FISH_FUNC_DIR"
            echo "   -> Copying fish function files..."
            cp ./fish/*.fish "$FISH_FUNC_DIR/"
            echo "   ...Done."
            INSTRUCTION="exec fish"
            ;;
        *)
            echo "⚠️ WARNING: Unsupported shell '$CURRENT_SHELL'."
            echo "You will need to manually install the aliases. The scripts are located in this directory."
            exit 1
            ;;
    esac

    # --- Final Instructions ---
    echo "\n--- ✅ SETUP COMPLETE ---"
    echo "The 'deskbackup' command is installed."
    echo "To activate the aliases, please run the following command:"
    echo "    $INSTRUCTION"
    echo "After that, you can run 'desk-import' to restore your configuration from a remote repository."
}

# Run the main function
main
